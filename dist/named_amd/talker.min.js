define("talker",[],function(){/*!
 * Â© 2014 Second Street, MIT License <http://opensource.org/licenses/MIT>
 * Talker.js 1.0.1 <http://github.com/secondstreet/talker.js>
 */
var TALKER_TYPE="application/x-talkerjs-v1+json",TALKER_ERR_TIMEOUT="timeout",pinkySwearPromise=function(){function a(a){return"function"==typeof a}function b(a){return"object"==typeof a}function c(a){"undefined"!=typeof setImmediate?setImmediate(a):"undefined"!=typeof process&&process.nextTick?process.nextTick(a):setTimeout(a,0)}var d;return function e(){var f,g=[],h=[],i=function(a,b){return null==f&&null!=a&&(f=a,g=b,h.length&&c(function(){for(var a=0;h.length>a;a++)h[a]()})),f};return i.then=function(i,j){var k=e(),l=function(){function c(e){var f,g=0;try{if(e&&(b(e)||a(e))&&a(f=e.then)){if(e===k)throw new TypeError;f.call(e,function(){g++||c.apply(d,arguments)},function(a){g++||k(!1,[a])})}else k(!0,arguments)}catch(h){g++||k(!1,[h])}}try{var e=f?i:j;a(e)?c(e.apply(d,g||[])):k(f,g)}catch(h){k(!1,[h])}};return null!=f?c(l):h.push(l),k},i}}(),objectCreate=function(a){function b(){}return b.prototype=a,new b},Talker=function(a,b){this.remoteWindow=a,this.remoteOrigin=b,this.timeout=3e3,this.handshaken=!1,this.handshake=pinkySwearPromise(),this._id=0,this._queue=[],this._sent={};var c=this;return window.addEventListener("message",function(a){c._receiveMessage(a)},!1),this._sendHandshake(),this};Talker.prototype.send=function(a,b,c){var d=new Talker.OutgoingMessage(this,a,b,c),e=pinkySwearPromise();return this._sent[d.id]=e,this._queue.push(d),this._flushQueue(),setTimeout(function(){e(!1,[new Error(TALKER_ERR_TIMEOUT)])},this.timeout),e},Talker.prototype._receiveMessage=function(a){var b,c;try{b=JSON.parse(a.data)}catch(d){b={}}return this._isSafeMessage(a.source,a.origin,b.type)?(c=b.handshake||b.handshakeConfirmation,c?this._handleHandshake(b):this._handleMessage(b)):!1},Talker.prototype._isSafeMessage=function(a,b,c){var d,e,f;return d=a===this.remoteWindow,e="*"===this.remoteOrigin||b===this.remoteOrigin,f=c===TALKER_TYPE,d&&e&&f},Talker.prototype._handleHandshake=function(a){a.handshake&&this._sendHandshake(this.handshaken),this.handshaken=!0,this.handshake(!0,[this.handshaken]),this._flushQueue()},Talker.prototype._handleMessage=function(a){var b=new Talker.IncomingMessage(this,a.namespace,a.data,a.id),c=a.responseToId;return c?this._respondToMessage(c,b):this._broadcastMessage(b)},Talker.prototype._respondToMessage=function(a,b){this._sent[a]&&(this._sent[a](!0,[b]),delete this._sent[a])},Talker.prototype._broadcastMessage=function(a){this.onMessage&&this.onMessage.call(this,a)},Talker.prototype._sendHandshake=function(a){var b={type:TALKER_TYPE},c=a?"handshakeConfirmation":"handshake";b[c]=!0,this._postMessage(b)},Talker.prototype._nextId=function(){return this._id+=1},Talker.prototype._postMessage=function(a){this.remoteWindow&&this.remoteOrigin&&this.remoteWindow.postMessage(JSON.stringify(a),this.remoteOrigin)},Talker.prototype._flushQueue=function(){if(this.handshaken){var a=this._queue.shift();if(!a)return this._queue;if(this._postMessage(a),this._queue.length>0)return this._flushQueue()}return this._queue},Talker.Message=function(a,b,c){return this.talker=a,this.namespace=b,this.data=c,this.type=TALKER_TYPE,this},Talker.OutgoingMessage=function(a,b,c,d){Talker.Message.call(this,a,b,c),this.responseToId=d||null,this.id=this.talker._nextId()},Talker.OutgoingMessage.prototype=objectCreate(Talker.Message.prototype),Talker.OutgoingMessage.prototype.constructor=Talker.Message,Talker.OutgoingMessage.prototype.toJSON=function(){return{id:this.id,responseToId:this.responseToId,namespace:this.namespace,data:this.data,type:this.type}},Talker.IncomingMessage=function(a,b,c,d){Talker.Message.call(this,a,b,c),this.id=d},Talker.IncomingMessage.prototype=objectCreate(Talker.Message.prototype),Talker.IncomingMessage.prototype.constructor=Talker.Message,Talker.IncomingMessage.prototype.respond=function(a){return this.talker.send(null,a,this.id)};
return Talker})